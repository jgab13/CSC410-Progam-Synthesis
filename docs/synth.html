<!DOCTYPE html>
<html>
<head>
  <meta http-equiv="content-type" content="text/html;charset=utf-8">
  <title>synth.py</title>
  <link rel="stylesheet" href="pycco.css">
</head>
<body>
<div id='container'>
  <div id="background"></div>
  <div class='section'>
    <div class='docs'><h1>synth.py</h1></div>
  </div>
  <div class='clearall'>
  <div class='section' id='section-0'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-0'>#</a>
      </div>
      <p>CSC410 Final Project: Enumerative Synthesizer
by Victor Nicolet and Danya Lette
Fill in this file to complete the synthesis portion
of the assignment.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span></span><span class="kn">from</span> <span class="nn">typing</span> <span class="kn">import</span> <span class="n">Mapping</span>
<span class="kn">from</span> <span class="nn">z3</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">lang.ast</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">lang.symb_eval</span> <span class="kn">import</span> <span class="n">Evaluator</span>
<span class="kn">from</span> <span class="nn">synthesis.synth_helper</span> <span class="kn">import</span> <span class="o">*</span>
<span class="kn">from</span> <span class="nn">verification</span> <span class="kn">import</span> <span class="n">verifier</span>
<span class="kn">import</span> <span class="nn">copy</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-1'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-1'>#</a>
      </div>
      <p>This class is has three methods <code>synth_method_1</code>, <code>synth_method_2</code> or
<code>synth_method_3</code> for generating expression for a program&rsquo;s holes.
You may also choose to add data attributes and methods to this class
to enable instances of <code>Synthesizer</code> to remember information about
previous runs.
Calling <code>synth_method_1</code>, <code>synth_method_2</code> or <code>synth_method_3</code> should
produce a new set of hole completions at each call for a given
<code>Synthesizer</code> instance.
For example, suppose the program p contains one hole <code>h1</code> with the
grammar <code>[ G : int -&gt; G + G | 0 | 1 ]</code>. Then, the following sequence
is a possible execution:</p>
<pre><code>&gt; s = Synthesizer(p)
&gt; s.synth_method_1()
{ &quot;h1&quot; : 0 }
&gt; s.synth_method_1()
{ &quot;h1&quot; : 1 }
&gt; s.synth_method_1()
{ &quot;h1&quot; : 0 + 1 }
...
</code></pre>
<p>Each call produces a hole completion. The returned object should
be a mapping from the hole id (its name) to the expression of the
hole.
Each <code>synth_method_..</code> should implement a different enumeration
strategy (e.g. depth first, breadth first, constants-first,
variables-first&hellip;).
<strong>Don&rsquo;t forget that we expect your third method to be the best on
average!</strong>
<em>Hint</em>: the method <code>hole_can_use</code> in the <code>Program</code> class returns the
set of variables that a given hole can use in its completions.
e.g. <code>prog.hole_can_use("h1")</code> returns the variables that &ldquo;h1&rdquo; can use.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre><span class="k">class</span> <span class="nc">Synthesizer</span><span class="p">():</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-2'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-2'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-3'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-3'>#</a>
      </div>
      <p>Initialize the Synthesizer.
The Synthesizer can have a state or other data attributes and
methods to remember which programs have been synthesized before.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">ast</span><span class="p">:</span> <span class="n">Program</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-4'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-4'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">state_number</span> <span class="o">=</span> <span class="mi">0</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-5'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-5'>#</a>
      </div>
      <p>The synthesizer is initialized with the program ast it needs
to synthesize hole completions for.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">ast</span> <span class="o">=</span> <span class="n">ast</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-6'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-6'>#</a>
      </div>
      <p>Track the current idx of the expanded recursive expression</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">recurIdx</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-7'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-7'>#</a>
      </div>
      <p>A list of stored outputs waiting for synth_method to call</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-8'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-8'>#</a>
      </div>
      <p>Output from the previous calls, used for GrammarIntSolver</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">last_output</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-9'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-9'>#</a>
      </div>
      <p>Prerecursive is the initial recursive expressions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="bp">self</span><span class="o">.</span><span class="n">prerecursive</span><span class="p">,</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">preprocess</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">recursive</span> <span class="o">=</span> <span class="n">copy</span><span class="o">.</span><span class="n">deepcopy</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prerecursive</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-10'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-10'>#</a>
      </div>
      <p>Preprocess to fill self.recursive and self.constant dicts with the
recursive rule or constant rule respectively</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">preprocess</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-11'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-11'>#</a>
      </div>
      <p>Dictionary using hole.var.name as key, rule.symbol.name as second key
storing all recursive expression for expand</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">recursive</span> <span class="o">=</span> <span class="p">{}</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-12'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-12'>#</a>
      </div>
      <p>Dictionary using hole.var.name as first key, rule.symbol.name as second
key storing all constant expression for substitution</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">constant</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">holes</span><span class="p">:</span>
            <span class="n">hole_name</span> <span class="o">=</span> <span class="n">hole</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">name</span>

            <span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>
            <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">{}</span>

            <span class="k">for</span> <span class="n">rule_indx</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">hole</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">)):</span>
                <span class="n">rule</span> <span class="o">=</span> <span class="n">hole</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="n">rule_indx</span><span class="p">]</span>
                <span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
                <span class="k">for</span> <span class="n">production</span> <span class="ow">in</span> <span class="n">rule</span><span class="o">.</span><span class="n">productions</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-13'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-13'>#</a>
      </div>
      <p>Constant expressions are IntConst, BoolConst, GrammarInt, GrammarVar</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">is_pure_expression</span><span class="p">(</span><span class="n">production</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">production</span><span class="p">,</span> <span class="n">GrammarInteger</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="n">production</span><span class="p">,</span> <span class="n">GrammarVar</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-14'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-14'>#</a>
      </div>
      <p>Check for GrammarVar</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">production</span><span class="p">,</span> <span class="n">GrammarVar</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-15'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-15'>#</a>
      </div>
      <p>Use hole_can_use to get all usable variables, only take same type</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                            <span class="n">valid_vars</span> <span class="o">=</span> <span class="p">[</span><span class="n">VarExpr</span><span class="p">(</span><span class="n">var</span><span class="p">,</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">)</span>
                                          <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">hole_can_use</span><span class="p">(</span><span class="n">hole_name</span><span class="p">)</span>
                                          <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">type</span> <span class="o">==</span> <span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">type</span><span class="p">]</span>

                            <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">valid_vars</span><span class="p">)</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">production</span><span class="p">)</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">production</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-16'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-16'>#</a>
      </div>
      <p>If there&rsquo;s any GrammarInteger in the constant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="nb">any</span><span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">GrammarInteger</span><span class="p">)</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-17'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-17'>#</a>
      </div>
      <p>Some basic pruning for GrammarInt:
1. Remove all other InstConst
2. If GrammarInt is the only constant, add a IntConst(0) for GrammarIntSolver (Scrach)
2. Maybe design a special case in grammarIntSolver if int is the only constant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="o">=</span>\
                    <span class="p">[</span><span class="n">expr</span> <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">rule</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span><span class="p">]</span> <span class="k">if</span> <span class="ow">not</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">IntConst</span><span class="p">)]</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-18'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-18'>#</a>
      </div>
      <p>Initialize self.outputs and self.recurIdx</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">recurIdx</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">main_prod_name</span> <span class="o">=</span> <span class="n">hole</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="p">[]</span>
            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">main_prod_name</span><span class="p">])</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-19'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-19'>#</a>
      </div>
      <p>Initialize self.last_output</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="bp">self</span><span class="o">.</span><span class="n">last_output</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="kc">None</span>

        <span class="k">return</span> <span class="n">recursive</span><span class="p">,</span> <span class="n">constant</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-20'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-20'>#</a>
      </div>
      <p>Given a almost pure expression (pure expression except having garmmarInt),
solve for the integer value using z3
Return a solved expression, None if unsat (no solution)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">grammarIntSolver</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">expr</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Expression</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-21'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-21'>#</a>
      </div>
      <p>raise NotImplementedError</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">sub_state</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_output</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

        <span class="n">counter</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">grammarint_expr</span> <span class="o">=</span> <span class="n">create_grammarint_expr</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">counter</span><span class="p">)</span>
        <span class="n">sub_state</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">grammarint_expr</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-22'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-22'>#</a>
      </div>
      <p>Check if there&rsquo;s a hole hasn&rsquo;t output</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">for</span> <span class="n">key</span> <span class="ow">in</span> <span class="n">sub_state</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-23'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-23'>#</a>
      </div>
      <p>key is hole_name</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">if</span> <span class="n">sub_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-24'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-24'>#</a>
      </div>
      <p>key hasn&rsquo;t output
Get the name of the main production</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">empty_main_prod_name</span> <span class="o">=</span> \
                    <span class="p">[</span><span class="n">hole</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span> <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">holes</span> <span class="k">if</span> <span class="n">hole</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">name</span> <span class="o">==</span> <span class="n">key</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="n">sub_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">key</span><span class="p">][</span><span class="n">empty_main_prod_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">sub_state</span><span class="p">[</span><span class="n">key</span><span class="p">],</span> <span class="n">GrammarInteger</span><span class="p">):</span>
                    <span class="n">sub_state</span><span class="p">[</span><span class="n">key</span><span class="p">]</span> <span class="o">=</span> <span class="n">IntConst</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">evaluator</span> <span class="o">=</span> <span class="n">Evaluator</span><span class="p">(</span><span class="n">sub_state</span><span class="p">)</span>
        <span class="n">final_constraint_expr</span> <span class="o">=</span> <span class="n">evaluator</span><span class="o">.</span><span class="n">evaluate</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="p">)</span>
        <span class="n">clauses</span> <span class="o">=</span> <span class="p">[</span><span class="n">create_clause</span><span class="p">(</span><span class="n">final_constraint_expr</span><span class="p">,</span> <span class="s1">&#39;&#39;</span><span class="p">)]</span>
        <span class="n">input_var</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">for</span> <span class="n">var</span> <span class="ow">in</span> <span class="n">final_constraint_expr</span><span class="o">.</span><span class="n">uses</span><span class="p">():</span>
            <span class="k">if</span> <span class="ow">not</span> <span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="o">.</span><span class="n">startswith</span><span class="p">(</span><span class="s1">&#39;Int_&#39;</span><span class="p">):</span>
                <span class="k">if</span> <span class="n">var</span><span class="o">.</span><span class="n">type</span><span class="o">.</span><span class="n">value</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-25'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-25'>#</a>
      </div>
      <p>Int</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">input_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Int</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>
                <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-26'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-26'>#</a>
      </div>
      <p>Bool</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="n">input_var</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Bool</span><span class="p">(</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">))</span>

        <span class="n">s</span> <span class="o">=</span> <span class="n">Solver</span><span class="p">()</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-27'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-27'>#</a>
      </div>
      <p>Set div0 and mod0 to be 0</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">x</span> <span class="o">=</span> <span class="n">Int</span><span class="p">(</span><span class="s1">&#39;INTEGER&#39;</span><span class="p">)</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">/</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">clauses</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">x</span> <span class="o">%</span> <span class="mi">0</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">input_var</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">ForAll</span><span class="p">(</span><span class="n">input_var</span><span class="p">,</span> <span class="n">And</span><span class="p">(</span><span class="n">clauses</span><span class="p">)))</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">s</span><span class="o">.</span><span class="n">add</span><span class="p">(</span><span class="n">And</span><span class="p">(</span><span class="n">clauses</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-28'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-28'>#</a>
      </div>
      <p>Set a 0.5 second timer on z3 solver</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">s</span><span class="o">.</span><span class="n">set</span><span class="p">(</span><span class="s2">&quot;timeout&quot;</span><span class="p">,</span> <span class="mi">500</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">s</span><span class="o">.</span><span class="n">check</span><span class="p">()</span> <span class="o">==</span> <span class="n">sat</span><span class="p">:</span>
            <span class="n">model</span> <span class="o">=</span> <span class="n">s</span><span class="o">.</span><span class="n">model</span><span class="p">()</span>
            <span class="n">new_expr</span> <span class="o">=</span> <span class="n">sub_int</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">grammarint_expr</span><span class="p">)</span>
            <span class="k">return</span> <span class="n">new_expr</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">return</span> <span class="kc">None</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-29'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-29'>#</a>
      </div>
      <p>Given a recursive expression, name of the current hole.
Expand the expression into more recursive expressions, return a list of expanded experssiosn
Call expand and substitute together when self.output[hole] is empty??
Please call equality check outside</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">expand</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recur</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-30'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-30'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">is_pure_expression</span><span class="p">(</span><span class="n">recur</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">recur</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">VarExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-31'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-31'>#</a>
      </div>
      <p>If the expressions is just the recursive var</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">name</span> <span class="o">=</span> <span class="n">recur</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">name</span>
            <span class="n">result</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">prerecursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">name</span><span class="p">])</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">UnaryExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-32'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-32'>#</a>
      </div>
      <p>Expand recursively on the unary operand</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-33'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-33'>#</a>
      </div>
      <p>Note simple pruning can be added for:
If two operands are the same and the operator is commutative (add, multiply, equality etc.)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">commutative</span> <span class="o">=</span> <span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">6</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">,</span> <span class="mi">13</span><span class="p">]</span>
            <span class="k">if</span><span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">left_operand</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">right_operand</span><span class="p">)</span>
                    <span class="ow">and</span> <span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="n">commutative</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">right_operand</span><span class="p">))</span>
            <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-34'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-34'>#</a>
      </div>
      <p>Expand recursively on the left operand</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">right_operand</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-35'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-35'>#</a>
      </div>
      <p>Expand recursively on the right operand</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">right_operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                    <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">Ite</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-36'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-36'>#</a>
      </div>
      <p>Expand recursively on the condition</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ite</span><span class="p">(</span><span class="n">expr</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">true_br</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">false_br</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-37'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-37'>#</a>
      </div>
      <p>Expand recursively on the true branch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">true_br</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ite</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">expr</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">false_br</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-38'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-38'>#</a>
      </div>
      <p>Expand recursively on the false branch</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">false_br</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ite</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">recur</span><span class="o">.</span><span class="n">true_br</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>
        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-39'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-39'>#</a>
      </div>
      <p>Only reach here if the intial grammar_expression has none fully recursive expression
Such as (True ? G : G) or (2 &gt; G)</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recur</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-40'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-40'>#</a>
      </div>
      <p>Given a recursive defined expression, substitute all constant in it
Return a list of substituted expression</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">substitute</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">recur</span><span class="p">:</span> <span class="n">Expression</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">:</span> <span class="nb">str</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">List</span><span class="p">[</span><span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-41'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-41'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">is_pure_expression</span><span class="p">(</span><span class="n">recur</span><span class="p">):</span>
            <span class="k">return</span> <span class="p">[</span><span class="n">recur</span><span class="p">]</span>

        <span class="n">result</span> <span class="o">=</span> <span class="p">[]</span>
        <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">VarExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-42'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-42'>#</a>
      </div>
      <p>Example: &ldquo;G&rdquo; -&gt; [x,y]</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">result</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">recur</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">name</span><span class="p">]</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">UnaryExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-43'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-43'>#</a>
      </div>
      <p>Substitute recursively on the unary operand</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">UnaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">expr</span><span class="p">))</span>

        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">BinaryExpr</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-44'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-44'>#</a>
      </div>
      <p>Substitute recursively on both side</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">lhs_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">left_operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">rhs_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">right_operand</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">str</span><span class="p">(</span><span class="n">lhs_expr</span><span class="p">)</span> <span class="o">==</span> <span class="nb">str</span><span class="p">(</span><span class="n">rhs_expr</span><span class="p">)</span> <span class="ow">and</span> <span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="o">.</span><span class="n">value</span> <span class="ow">in</span> <span class="p">[</span><span class="mi">11</span><span class="p">,</span> <span class="mi">12</span><span class="p">]):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">BinaryExpr</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">operator</span><span class="p">,</span> <span class="n">lhs_expr</span><span class="p">,</span> <span class="n">rhs_expr</span><span class="p">))</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-45'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-45'>#</a>
      </div>
      <p>Similarly, some simple pruning can be added here</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">elif</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">recur</span><span class="p">,</span> <span class="n">Ite</span><span class="p">):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-46'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-46'>#</a>
      </div>
      <p>Substitute recursively on all three expressions</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="k">for</span> <span class="n">cond_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">cond</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                <span class="k">for</span> <span class="n">true_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">true_br</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                    <span class="k">for</span> <span class="n">false_expr</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">recur</span><span class="o">.</span><span class="n">false_br</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">):</span>
                        <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">Ite</span><span class="p">(</span><span class="n">cond_expr</span><span class="p">,</span> <span class="n">true_expr</span><span class="p">,</span> <span class="n">false_expr</span><span class="p">))</span>

        <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-47'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-47'>#</a>
      </div>
      <p>Only reach here if the intial grammar_expression has none fully recursive expression</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>            <span class="n">result</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">recur</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">result</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-48'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-48'>#</a>
      </div>
      <p>The main algorithm method for synthesising.</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">synth_main</span><span class="p">(</span><span class="bp">self</span><span class="p">)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-49'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-49'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">res</span> <span class="o">=</span> <span class="p">{}</span>

        <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">holes</span><span class="p">:</span>
            <span class="n">hole_name</span> <span class="o">=</span> <span class="n">hole</span><span class="o">.</span><span class="n">var</span><span class="o">.</span><span class="n">name</span>
            <span class="n">main_prod_name</span> <span class="o">=</span> <span class="n">hole</span><span class="o">.</span><span class="n">grammar</span><span class="o">.</span><span class="n">rules</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">symbol</span><span class="o">.</span><span class="n">name</span>

            <span class="n">res_expr</span> <span class="o">=</span> <span class="kc">None</span>
            <span class="k">while</span> <span class="n">res_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-50'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-50'>#</a>
      </div>
      <p>The output list is empty for this hole</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-51'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-51'>#</a>
      </div>
      <p>Check if the produciton rules are finite</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                    <span class="k">if</span> <span class="bp">self</span><span class="o">.</span><span class="n">recurIdx</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">main_prod_name</span><span class="p">]):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-52'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-52'>#</a>
      </div>
      <p>There is no more recursive expression that we can expand
We&rsquo;ve tried every possible hole_completion
return a dummy data (last output value) instead</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">res_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">last_output</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">res_expr</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
                            <span class="n">res_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">main_prod_name</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
                            <span class="k">if</span> <span class="nb">isinstance</span><span class="p">(</span><span class="n">res_expr</span><span class="p">,</span> <span class="n">GrammarInteger</span><span class="p">):</span>
                                <span class="n">res_expr</span> <span class="o">=</span> <span class="n">IntConst</span><span class="p">(</span><span class="mi">1</span><span class="p">)</span>
                        <span class="k">break</span>
                    <span class="k">else</span><span class="p">:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-53'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-53'>#</a>
      </div>
      <p>A do_while loop prevent the preventing VarExpr without constant</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">do_while</span> <span class="o">=</span> <span class="kc">True</span>
                        <span class="k">while</span> <span class="n">do_while</span> <span class="ow">or</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]:</span>
                            <span class="n">currRecur</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">main_prod_name</span><span class="p">][</span><span class="bp">self</span><span class="o">.</span><span class="n">recurIdx</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]]</span>
                            <span class="n">new_recurs</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">expand</span><span class="p">(</span><span class="n">currRecur</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">)</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">recursive</span><span class="p">[</span><span class="n">hole_name</span><span class="p">][</span><span class="n">main_prod_name</span><span class="p">]</span><span class="o">.</span><span class="n">extend</span><span class="p">(</span><span class="n">new_recurs</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-54'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-54'>#</a>
      </div>
      <p>Update self.recurIdx</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                            <span class="bp">self</span><span class="o">.</span><span class="n">recurIdx</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">+=</span> <span class="mi">1</span>

                            <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">substitute</span><span class="p">(</span><span class="n">currRecur</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">)</span>
                            <span class="n">do_while</span> <span class="o">=</span> <span class="kc">False</span>

                <span class="n">res_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">outputs</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-55'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-55'>#</a>
      </div>
      <p>Check if a GrammarInt is in the expression
Having GrammarInt in the expression is the only reason of a False in is_pure_expression check</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="k">if</span> <span class="ow">not</span> <span class="bp">self</span><span class="o">.</span><span class="n">ast</span><span class="o">.</span><span class="n">is_pure_expression</span><span class="p">(</span><span class="n">res_expr</span><span class="p">):</span>
                    <span class="n">res_expr</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">grammarIntSolver</span><span class="p">(</span><span class="n">res_expr</span><span class="p">,</span> <span class="n">hole_name</span><span class="p">)</span>

            <span class="n">res</span><span class="p">[</span><span class="n">hole_name</span><span class="p">]</span> <span class="o">=</span> <span class="n">res_expr</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">last_output</span> <span class="o">=</span> <span class="n">res</span>
        <span class="k">return</span> <span class="n">res</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-56'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-56'>#</a>
      </div>
      <p>Returns a map from each hole id in the program <code>self.ast</code>
to an expression (method 1).
<strong>
A variable first algorithm. Variables are priortized over constants and will be evaluated first.
constants will also get evaluated right after all the constants so that the potential correct hole completion
won&rsquo;t be missed.
</strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">synth_method_1</span><span class="p">(</span><span class="bp">self</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-57'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-57'>#</a>
      </div>
      <p>make it variable first</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">constant_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-58'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-58'>#</a>
      </div>
      <p>put all constants in front of all vars</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="ow">not</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">IntConst</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">BoolConst</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-59'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-59'>#</a>
      </div>
      <p>put const at the beginning of the list</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">var</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">var</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>

        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synth_main</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="n">constant_save</span>
        <span class="k">return</span> <span class="n">res</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-60'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-60'>#</a>
      </div>
      <p>Returns a map from each hole id in the program <code>self.ast</code>
to an expression (method 2).
<strong>A constant first algorithm. constants are priortized over variables and will be evaluated first.
Variables will also get evaluated right after all the constants so that the potential correct hole completion
won&rsquo;t be missed. </strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">synth_method_2</span><span class="p">(</span><span class="bp">self</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-61'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-61'>#</a>
      </div>
      <p>make it constant first</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="n">constant_save</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">for</span> <span class="n">hole</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">prod</span> <span class="ow">in</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-62'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-62'>#</a>
      </div>
      <p>put all constants in front of all vars</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                <span class="n">i</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">while</span> <span class="n">i</span> <span class="o">&lt;</span> <span class="nb">len</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]):</span>
                    <span class="k">if</span> <span class="p">(</span><span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">IntConst</span><span class="p">)</span> <span class="ow">or</span>
                            <span class="nb">isinstance</span><span class="p">(</span><span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">][</span><span class="n">i</span><span class="p">],</span> <span class="n">BoolConst</span><span class="p">)):</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-63'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-63'>#</a>
      </div>
      <p>put const at the beginning of the list</p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>                        <span class="n">const</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">pop</span><span class="p">(</span><span class="n">i</span><span class="p">)</span>
                        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span><span class="p">[</span><span class="n">hole</span><span class="p">][</span><span class="n">prod</span><span class="p">]</span><span class="o">.</span><span class="n">insert</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">const</span><span class="p">)</span>
                    <span class="n">i</span> <span class="o">+=</span> <span class="mi">1</span>
        <span class="n">res</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">synth_main</span><span class="p">()</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">constant</span> <span class="o">=</span> <span class="n">constant_save</span>
        <span class="k">return</span> <span class="n">res</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-64'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-64'>#</a>
      </div>
      <p>Returns a map from each hole id in the program <code>self.ast</code>
to an expression (method 3).
<strong>This search algorithm uses BFS to expand the rules for each production rule, starting with primitives such as
constants and variables. Then it builds recursive expressions based on these primitives and the process continues
as increasingly nested recursive expressions are expanded and added to the queue. Simple pruning is used to remove
unnecessary redundant expressions such as &lsquo;x1 &amp;&amp; x1&rsquo; or &lsquo;x1 || x1&rsquo;. Additionally, we use z3 on any expression that
contains a grammar integer to find a satisfying assignment.</strong></p>
    </div>
    <div class='code'>
      <div class="highlight"><pre>    <span class="k">def</span> <span class="nf">synth_method_3</span><span class="p">(</span><span class="bp">self</span><span class="p">,)</span> <span class="o">-&gt;</span> <span class="n">Mapping</span><span class="p">[</span><span class="nb">str</span><span class="p">,</span> <span class="n">Expression</span><span class="p">]:</span></pre></div>
    </div>
  </div>
  <div class='clearall'></div>
  <div class='section' id='section-65'>
    <div class='docs'>
      <div class='octowrap'>
        <a class='octothorpe' href='#section-65'>#</a>
      </div>
      
    </div>
    <div class='code'>
      <div class="highlight"><pre>        <span class="k">return</span> <span class="bp">self</span><span class="o">.</span><span class="n">synth_main</span><span class="p">()</span>

</pre></div>
    </div>
  </div>
  <div class='clearall'></div>
</div>
</body>
